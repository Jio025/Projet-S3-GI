<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js" defer></script>
    <script src="http://localhost:8180/js/keycloak.js" defer></script>
    <script>
        let keycloak = null;
        let kcReady = false;

        function setButtonsEnabled(enabled) {
            for (const id of ["btnStudent", "btnTeacher", "btnMessage"]) {
                const el = document.getElementById(id);
                if (el) el.disabled = !enabled;
            }
        }

        async function initKeycloak() {
            try {
                if (typeof window.Keycloak !== "function") {
                    alert("Keycloak JS non chargé.");
                    return;
                }
                keycloak = new Keycloak({
                    realm: "usager",
                    "auth-server-url": "http://localhost:8180/",
                    "ssl-required": "external",
                    clientId: "frontend",
                    "public-client": true,
                    "confidential-port": 0
                });
                const authenticated = await keycloak.init({ onLoad: "login-required", checkLoginIframe: false });
                kcReady = true;
                setButtonsEnabled(true);
                setInterval(async () => {
                    try { await keycloak.updateToken(30); }
                    catch (e) { keycloak.login(); }
                }, 10000);
            } catch (e) {
                alert("Échec d'initialisation Keycloak");
            }
        }

        async function authorizedGet(url) {
            if (!kcReady || !keycloak) throw new Error("Keycloak pas prêt");
            await keycloak.updateToken(5).catch(() => keycloak.login());
            return axios.get(url, { headers: { Authorization: "Bearer " + keycloak.token } });
        }

        async function requestStudent() {
            const span = document.querySelector("#title > span");
            span.textContent = "Chargement…";
            try {
                if (!kcReady || !keycloak) throw new Error("Keycloak pas prêt");
                const resp = await authorizedGet("/api/student");
                span.innerHTML =
                    "<br><strong>" + resp.data.cip + "</strong>" +
                    "<br><strong>" + resp.data.last_name + "</strong>" +
                    "<br><strong>" + resp.data.first_name + "</strong>" +
                    "<br><strong>" + resp.data.email + "</strong>" +
                    "<br><strong>" + resp.data.roles + "</strong>";
            } catch (err) {
                if (err.response) {
                    span.innerHTML = "<br><strong>Erreur " + err.response.status + "</strong><br>" +
                        (typeof err.response.data === "object" ? JSON.stringify(err.response.data) : err.response.data);
                } else {
                    span.innerHTML = "<br><strong>Erreur</strong>";
                }
            }
        }

        async function requestTeacher() {
            const span = document.querySelector("#title > span");
            span.textContent = "Chargement…";
            try {
                if (!kcReady || !keycloak) throw new Error("Keycloak pas prêt");
                const resp = await authorizedGet("/api/teacher");
                span.innerHTML =
                    "<br><strong>" + resp.data.cip + "</strong>" +
                    "<br><strong>" + resp.data.last_name + "</strong>" +
                    "<br><strong>" + resp.data.first_name + "</strong>" +
                    "<br><strong>" + resp.data.email + "</strong>" +
                    "<br><strong>" + resp.data.roles + "</strong>";
            } catch (err) {
                if (err.response) {
                    span.innerHTML = "<br><strong>Erreur " + err.response.status + "</strong><br>" +
                        (typeof err.response.data === "object" ? JSON.stringify(err.response.data) : err.response.data);
                } else {
                    span.innerHTML = "<br><strong>Erreur</strong>";
                }
            }
        }

        async function requestMessage() {
            const span = document.querySelector("#title > span");
            span.textContent = "Chargement…";
            try {
                if (!kcReady || !keycloak) throw new Error("Keycloak pas prêt");
                const resp = await authorizedGet("/api/getmessages/e24/s3i/app2");
                span.innerHTML = "";
                for (const m of resp.data) {
                    span.innerHTML += "<br><strong>" + m.cip + "</strong>" +
                        "<br><strong>" + m.description + "</strong><br>";
                }
                if (!resp.data || resp.data.length === 0) {
                    span.innerHTML = "<br><strong>Aucun message</strong><br>";
                }
            } catch (err) {
                if (err.response) {
                    span.innerHTML = "<br><strong>Erreur " + err.response.status + "</strong><br>" +
                        (typeof err.response.data === "object" ? JSON.stringify(err.response.data) : err.response.data);
                } else {
                    span.innerHTML = "<br><strong>Erreur</strong>";
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            setButtonsEnabled(false);
            initKeycloak();
        });
    </script>
</head>
<body>
<button id="btnStudent" onclick="requestStudent()">Étudiant?</button>
<button id="btnTeacher" onclick="requestTeacher()">Enseignant?</button>
<button id="btnMessage" onclick="requestMessage()">Message app2?</button>
<div id="title"><span></span></div>
</body>
</html>
